const qrcode = require('qrcode-terminal');
const { Client } = require('whatsapp-web.js');
const client = new Client();

// Gerar QR code para autenticaÃ§Ã£o do WhatsApp
client.on('qr', qr => {
    qrcode.generate(qr, { small: true });
});

// Quando a conexÃ£o estiver pronta
client.on('ready', () => {
    console.log('Tudo certo! WhatsApp conectado.');
});

// Inicializa o cliente
client.initialize();

// FunÃ§Ã£o de delay para simular digitaÃ§Ã£o
const delay = ms => new Promise(res => setTimeout(res, ms));

// FunÃ§Ã£o para aguardar respostas
async function aguardarResposta(chat, user) {
    return new Promise(resolve => {
        client.on('message', async (msg) => {
            if (msg.from === user) {
                resolve(msg.body);
            }
        });
    });
}

// FunÃ§Ã£o para validar o formato do CEP (ex: 11500-550)
function validarCEP(cep) {
    const regex = /^[0-9]{5}-[0-9]{3}$/;
    return regex.test(cep); // Retorna true se o CEP for vÃ¡lido, senÃ£o retorna false
}

// FunÃ§Ã£o para validar resposta de "Sim" ou "NÃ£o"
function validarSimOuNao(resposta) {
    return /^(sim|nÃ£o)$/i.test(resposta);
}

// FunÃ§Ã£o para validar se a resposta estÃ¡ dentro das opÃ§Ãµes
function validarOpcoesMenu(resposta) {
    return /^[A-E]([1-5])$/.test(resposta); // Aceita apenas A1, B2, C3, D4, E5
}

// Fluxo de mensagens
client.on('message', async msg => {
    const chat = await msg.getChat();
    const user = msg.from;
    let emMenu = true;  // VariÃ¡vel de controle para saber se estamos no menu
    let emCadastro = false;  // VariÃ¡vel para controle do fluxo de cadastro

    // FunÃ§Ã£o de iniciar o menu
    async function enviarMenu() {
        await delay(3000);
        await chat.sendStateTyping();
        await delay(3000);
        await client.sendMessage(user, `OlÃ¡! Aqui Ã© o Davi, sou consultor de novos imÃ³veis do Quinto Andar. Como posso ajudar? Digite o nÃºmero de uma das opÃ§Ãµes abaixo:\n\nA1 - *Quero anunciar meu imÃ³vel* ğŸ¡\nB2 - *Saber mais sobre o Quinto Andar* ğŸ“š\nC3 - *InformaÃ§Ãµes sobre valores* ğŸ’°\nD4 - *Indicar um proprietÃ¡rio* ğŸ§‘â€ğŸ’¼\nE5 - *Falar com um corretor* ğŸ§‘â€ğŸ’¼\n\nOu digite *voltar* para voltar ao menu principal.`);
    }

    // Inicia o menu inicial com saudaÃ§Ã£o personalizada
    if (msg.body.match(/(oi|olÃ¡|ola|oee|bom dia|boa tarde|boa noite|tenho|sim|nÃ£o|quem|ok)/i) && user.endsWith('@c.us')) {
        await delay(3000);
        const contact = await msg.getContact();
        const name = contact.pushname || "usuÃ¡rio"; // Nome do usuÃ¡rio ou "usuÃ¡rio" se nÃ£o encontrado
        await chat.sendStateTyping();
        await delay(3000);
        await client.sendMessage(user, `OlÃ¡ ${name.split(" ")[0]}! Aqui Ã© o Davi, sou consultor de novos imÃ³veis do Quinto Andar. Como posso ajudar? Digite o nÃºmero de uma das opÃ§Ãµes abaixo:\n\nA1 - *Quero anunciar meu imÃ³vel* ğŸ¡\nB2 - *Saber mais sobre o Quinto Andar* ğŸ“š\nC3 - *InformaÃ§Ãµes sobre valores* ğŸ’°\nD4 - *Indicar um proprietÃ¡rio* ğŸ§‘â€ğŸ’¼\nE5 - *Falar com um corretor* ğŸ§‘â€ğŸ’¼\n\nOu digite *voltar* para voltar ao menu principal.`);
    }

    // Se o usuÃ¡rio digitar "voltar" a qualquer momento, envia o menu novamente
    if (msg.body.toLowerCase() === 'voltar' && !emCadastro) {
        emMenu = true;
        await enviarMenu();
    }

    // Se o usuÃ¡rio escolher uma das opÃ§Ãµes do menu (A1 - E5)
    if (emMenu && validarOpcoesMenu(msg.body)) {
        // Se a opÃ§Ã£o for A1 (Quero anunciar meu imÃ³vel), entra no fluxo de cadastro
        if (msg.body === 'A1') {
            emMenu = false;
            emCadastro = true; // Inicia o cadastro
            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);
            await client.sendMessage(user, 'Ã“tima escolha! ğŸ¡\nVou precisar de algumas informaÃ§Ãµes sobre o imÃ³vel. \n\n*Informe somente o solicitado.*');

            // Pergunta o CEP do imÃ³vel
            let cep;
            do {
                await delay(3000);
                await chat.sendStateTyping();
                await delay(3000);
                await client.sendMessage(user, 'Qual o CEP do imÃ³vel? ğŸ“');
                cep = await aguardarResposta(chat, user); // Aguarda resposta do usuÃ¡rio
                if (!validarCEP(cep)) {
                    await client.sendMessage(user, 'CEP invÃ¡lido! ğŸ˜ Por favor, insira o CEP no formato correto (ex: 11500-550).');
                }
            } while (!validarCEP(cep)); // Continua perguntando atÃ© o CEP ser vÃ¡lido

            // Pergunta o endereÃ§o, nÃºmero e complemento
            const endereco = await pedirInformacao(user, 'Qual o endereÃ§o do imÃ³vel? ğŸ ');
            const numero = await pedirInformacao(user, 'Qual o nÃºmero do imÃ³vel? ğŸ ');
            const complemento = await pedirInformacao(user, 'Qual o complemento do imÃ³vel? (Ex: apto, bloco, etc) ğŸ¢');
            const andar = await pedirInformacao(user, 'O imÃ³vel possui andar especÃ­fico? (Ex: andar, cobertura, etc) ğŸ¢');
            const tipoAnuncio = await pedirInformacao(user, 'Qual o tipo de anÃºncio vocÃª gostaria de fazer? (Aluguel, Venda, Ambos) ğŸ’¼');
            const tipoImovel = await pedirInformacao(user, 'Qual o tipo de imÃ³vel? (Ex: Apartamento, Kitnet, Casa, etc.) ğŸ¡');
            const areaImovel = await pedirInformacao(user, 'Qual a Ã¡rea do imÃ³vel em metros quadrados? ğŸ“ (Caso nÃ£o saiba, coloque um valor aproximado)');
            const vagasGaragem = await pedirInformacao(user, 'Quantas vagas de garagem o imÃ³vel possui? ğŸš—');
            const banheiros = await pedirInformacao(user, 'Quantos banheiros o imÃ³vel possui? ğŸš¿');
            const quartos = await pedirInformacao(user, 'Quantos quartos o imÃ³vel possui? ğŸ›ï¸');
            const suites = await pedirInformacao(user, 'Quantos desses quartos sÃ£o suÃ­tes? ğŸ›');
            const itensNoImovel = await pedirInformacao(user, 'ImÃ³vel com ou sem mobÃ­lia? ğŸ›ï¸');
            const aceitaPet = await pedirInformacao(user, 'Inquilinos podem ter animais de estimaÃ§Ã£o? (Sim/NÃ£o) ğŸ¾');
            const descricaoImovel = await pedirInformacao(user, 'FaÃ§a uma breve descriÃ§Ã£o do imÃ³vel: (Compartilhe com os interessados as caracterÃ­sticas Ãºnicas do imÃ³vel.) âœ¨');
            const horarioPort = await pedirInformacao(user, 'Qual o horÃ¡rio da portaria? (24h/Diurna/Noturna/Sem portaria) â°');
            const tipoEntrada = await pedirInformacao(user, 'Qual o tipo de entrada no imÃ³vel? (Chaves/Senha/Biometria) ğŸ”‘');
            const infoEntrada = await pedirInformacao(user, 'InformaÃ§Ãµes adicionais de entrada. (Informar se a chave ficarÃ¡ na portaria ou se ficarÃ¡ em outra localizaÃ§Ã£o - *Chaves na portaria aluga mais rÃ¡pido*) ğŸ—ï¸');
            const condominio = await pedirInformacao(user, 'Valor do condomÃ­nio mensal ğŸ’µ');
            const iptuValor = await pedirInformacao(user, 'O imÃ³vel estÃ¡ sujeito ao pagamento de IPTU? (Se sim, informar o valor ANUAL) ğŸ’°');
            const aluguelVenda = await pedirInformacao(user, 'Informar valor do Aluguel / Venda sem contar com o condominio e IPTU? (Se for ambos, informar na mesma mensagem) ğŸ’²');
            const nomeProprietario = await pedirInformacao(user, 'Por favor, informe o nome do proprietÃ¡rio do imÃ³vel. ğŸ¡');
            const celularProprietario = await pedirInformacao(user, 'Por favor, informe o celular do proprietÃ¡rio do imÃ³vel com DDD. ğŸ“');

            const dadosImovel = {
                cep,
                endereco,
                numero,
                complemento,
                andar,
                tipoAnuncio,
                tipoImovel,
                areaImovel,
                vagasGaragem,
                banheiros,
                quartos,
                suites,
                itensNoImovel,
                aceitaPet,
                descricaoImovel,
                horarioPort,
                tipoEntrada,
                infoEntrada,
                condominio,
                iptuValor,
                aluguelVenda,
                nomeProprietario,
                celularProprietario,
            };

            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);

            // Exibe o checklist de dados
            let confirmacao = 'Aqui estÃ£o as informaÃ§Ãµes que vocÃª forneceu:\n\n';
            for (let key in dadosImovel) {
                confirmacao += `*${key}:* ${dadosImovel[key]}\n`;
            }

            confirmacao += `\nPor favor, confirme se todas as informaÃ§Ãµes estÃ£o corretas. Digite *sim* para confirmar ou *nÃ£o* para corrigir algum dado.\n\nSe precisar corrigir algum dado, basta digitar o campo que deseja alterar (ex: "CEP", "endereÃ§o", "nÃºmero", etc).`;

            await client.sendMessage(user, confirmacao);

            // Aguardar confirmaÃ§Ã£o ou solicitaÃ§Ã£o de correÃ§Ã£o
            const resposta = await aguardarResposta(chat, user);

            if (resposta.toLowerCase() === 'sim') {
                // Confirmou, finaliza o cadastro
                await finalizarCadastro();
            } else if (resposta.toLowerCase() === 'nÃ£o') {
                // O usuÃ¡rio deseja corrigir algum dado
                await corrigirDado();
            } else {
                // Caso a resposta nÃ£o seja sim nem nÃ£o, pergunta novamente
                await client.sendMessage(user, 'Por favor, responda *sim* para confirmar ou *nÃ£o* para corrigir.');
            }

            // FunÃ§Ã£o para finalizar o cadastro
            async function finalizarCadastro() {
                await delay(3000);
                await chat.sendStateTyping();
                await delay(3000);
                await client.sendMessage(user, 'Obrigado pelas informaÃ§Ãµes! \nQuando for concluÃ­do o prÃ©-cadastro, vocÃª receberÃ¡ uma mensagem pelo WhatsApp para confirmaÃ§Ã£o do cadastro e serÃ¡ feito o agendamento da sessÃ£o de fotos com o nosso fotÃ³grafo. \n\nNÃ£o Ã© necessÃ¡rio estar presente durante a sessÃ£o, basta garantir que o acesso ao imÃ³vel esteja disponÃ­vel para a realizaÃ§Ã£o das fotos e vÃ­deos. ğŸ“¸ğŸ˜Š');
            }

            // FunÃ§Ã£o para corrigir dados
            async function corrigirDado() {
                await client.sendMessage(user, 'Digite o campo que vocÃª deseja corrigir (ex: "CEP", "endereÃ§o", etc):');
                const campoParaCorrigir = await aguardarResposta(chat, user);

                if (dadosImovel[campoParaCorrigir]) {
                    // Perguntar novamente a informaÃ§Ã£o para corrigir
                    await client.sendMessage(user, `Vamos corrigir o(a) ${campoParaCorrigir}. Por favor, forneÃ§a o novo valor:`);
                    const novaInformacao = await aguardarResposta(chat, user);
                    dadosImovel[campoParaCorrigir] = novaInformacao;

                    // ApÃ³s a correÃ§Ã£o, exibe novamente o checklist
                    await client.sendMessage(user, `InformaÃ§Ã£o corrigida! Aqui estÃ¡ o checklist atualizado:\n\n`);
                    let confirmacaoCorrigida = '';
                    for (let key in dadosImovel) {
                        confirmacaoCorrigida += `*${key}:* ${dadosImovel[key]}\n`;
                    }
                    await client.sendMessage(user, confirmacaoCorrigida);

                    await client.sendMessage(user, 'Agora, por favor, confirme novamente se tudo estÃ¡ correto: *sim* ou *nÃ£o*');
                    const respostaConfirmacao = await aguardarResposta(chat, user);

                    if (respostaConfirmacao.toLowerCase() === 'sim') {
                        await finalizarCadastro();
                    } else {
                        await corrigirDado();
                    }
                } else {
                    await client.sendMessage(user, 'Campo nÃ£o encontrado. Por favor, digite corretamente o nome do campo que deseja corrigir.');
                    await corrigirDado();
                }
            }

            // FunÃ§Ã£o para pedir uma informaÃ§Ã£o ao usuÃ¡rio
            async function pedirInformacao(user, pergunta) {
                await delay(3000);
                await chat.sendStateTyping();
                await delay(3000);
                await client.sendMessage(user, pergunta);
                return await aguardarResposta(chat, user);
            }
        }

        // Se a opÃ§Ã£o for B2 - Saber mais sobre o Quinto Andar
        else if (msg.body === 'B2') {
            emMenu = false;
            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);
            await client.sendMessage(user, 'ğŸ“š *Saber mais sobre o Quinto Andar*\n\nO Quinto Andar Ã© a maior plataforma de moradia do Brasil ğŸ‡§ğŸ‡·, oferecendo uma experiÃªncia simples e transparente para quem busca um lugar para morar ğŸ¡ ou deseja alugar ou vender seu imÃ³vel ğŸ’¼.\n\nA empresa administra exclusivamente imÃ³veis residenciais ğŸ  e ainda nÃ£o opera com imÃ³veis comerciais ğŸ¢.\n\nAtualmente, o Quinto Andar estÃ¡ presente em 75 cidades brasileiras ğŸŒ, com mais de R$ 155 bilhÃµes em ativos ğŸ’° e mais de 265 mil contratos sob gestÃ£o ğŸ“‘.\n\nA cada mÃªs, cerca de 12 mil novos contratos de aluguel sÃ£o fechados ğŸ“ por meio de sua plataforma, o que equivale a um novo contrato a cada 4 minutos â±ï¸.\n\nAlÃ©m disso, mais de 14 mil novos imÃ³veis sÃ£o anunciados mensalmente ğŸ ğŸ“ˆ. Para proporcionar uma experiÃªncia inesquecÃ­vel para quem precisa de um lar ou anuncia com a empresa, o Quinto Andar aposta em design, seguranÃ§a e tecnologia de ponta ğŸ’»ğŸ”’.\n\nO envio da documentaÃ§Ã£o Ã© totalmente digital ğŸ“², e a anÃ¡lise de crÃ©dito Ã© feita rapidamente ğŸš€, tornando o processo de locaÃ§Ã£o mais Ã¡gil e eficiente âš¡. AlÃ©m disso, o Quinto Andar oferece produtos financeiros ğŸ’³, como a garantia locatÃ­cia, para viabilizar a etapa financeira da conquista de um novo lar ğŸ¡, alÃ©m de oferecer mais agilidade para imobiliÃ¡rias e corretores focarem no que realmente importa: fazer novos negÃ³cios ğŸ“ŠğŸ’¼.');
        }

        // Se a opÃ§Ã£o for C3 - InformaÃ§Ãµes sobre valores
        else if (msg.body === 'C3') {
            emMenu = false;
            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);
            await client.sendMessage(user, 'ğŸ“š *InformaÃ§Ãµes sobre valores*\n\nSaiba mais em:\n\nhttps://help.quintoandar.com.br/hc/pt-br/articles/115000643292-O-que-%C3%A9-a-taxa-de-corretagem-QuintoAndar-E-a-taxa-de-administra%C3%A7%C3%A3o-QuintoAndar .');
        }

        // Se a opÃ§Ã£o for D4 - Indicar um proprietÃ¡rio
        else if (msg.body === 'D4') {
            emMenu = false;
            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);
            await client.sendMessage(user, 'ğŸ“š *Indicar um proprietÃ¡rio* ğŸ§‘â€ğŸ’¼\n\nğŸ“‹ Se vocÃª conhece algum proprietÃ¡rio de imÃ³vel que gostaria de anunciar no Quinto Andar, basta nos enviar os dados dele aqui! \nNÃ³s entraremos em contato com ele.\n\nInforme o nome e telefone do proprietÃ¡rio do imÃ³vel. ğŸ“\n\nğŸ™ Agradecemos a indicaÃ§Ã£o!.');
        }

        // Se a opÃ§Ã£o for E5 - Falar com um corretor
        else if (msg.body === 'E5') {
            emMenu = false;
            await delay(3000);
            await chat.sendStateTyping();
            await delay(3000);
            await client.sendMessage(user, 'ğŸ“ *Falar com um corretor* ğŸ§‘â€ğŸ’¼\n\nEntre em contato pelo WhatsApp: ğŸ“± (13) 98225 1000.\n\nEstamos Ã  disposiÃ§Ã£o para ajudar vocÃª! ğŸ’¬');
        }
    }
});

// FunÃ§Ã£o para reiniciar o menu quando nÃ£o estiver em um cadastro
async function enviarMenuNovamente(chat, user) {
    if (!emCadastro) {
        await delay(3000);
        await chat.sendStateTyping();
        await delay(3000);
        await client.sendMessage(user, 'Escolha uma das opÃ§Ãµes novamente:\nA1 - Quero anunciar meu imÃ³vel ğŸ¡\nB2 - Saber mais sobre o Quinto Andar ğŸ“š\nC3 - InformaÃ§Ãµes sobre valores ğŸ’°\nD4 - Indicar um proprietÃ¡rio ğŸ§‘â€ğŸ’¼\nE5 - Falar com um corretor ğŸ§‘â€ğŸ’¼');
    }
}
